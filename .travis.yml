services:
  - docker

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2
    - secure: "gI633DgZU99ZARBREuVi0R2puPM/cPacs0t8iHJh7r0u+UlaxrSMQAmcM7Cuqge2lVx4TCUJhybGQGFZKjT/EzyOAPDOJlk2dwy0x9PNKWK3PKKEMMYiYmjYNBVSqeY4pPwpaRmjkEwSxJT1eh+z/xswq8Pqi1HkDrkfcOGmdQZpZW98NwOBb7L1CkFasl0C2h0yogl/oSfx5SeJ20c6tCnBPr7aPEUP076dR9LUfd+D5a+PFfQZV6vDK0k6TCIf6a1RGJORMKp+Eq1mFHssqkrs1IAQu0zRqDMoWP10J4Z2IrRsPs1HpFJ6kL+SJ+KliaWejzNBVmxxe8+le0v/pny5AEW+NC1v0FeTK1j5fa8PX5m90c7R0PNsER2pDlqfqWSS2PfAgXMchlJEt6lKlyMKZj+ZbsIcVPeEi9VV2qwUeN9dmHUNTFi6smtQw4m/JIEl1jpNfKPeVcyhWOz2Ifv7nED0MVNX7gX96obrsqlnAD0o2JvobYvVOhXg3y74ICICvgikoHnZaEBOd016wey0YMynAw9yxv7HttMFLFaZ3+EG3NXEEjXbMHLyZ1qs/rh53XNt4nuy0YZ+2mjVIwg4cD3hk/7Rsw2B+3MauIEmB6RbwuJOAUwR5nwbNmihyyKtaKw5iSPblfvevzgx3nFKYOfNskOJXv3xqEWf1z8="
    - secure: "Ma2WhocBK1pqBvbz7mdDsE5LJXKI4brsbHUSDlH3ixQvS7ooQHWQs9Uf2SIDhx9EGXMUc9kaEWr6RLDYhfl+vErAOFnHQn5IPT3lh2WpKT9WgJs2x/6J3scrY0u2r+9RGRcY+yYS7w88sBHQYX8x6oMddD6n7Hz8BGikSm1NYmhMrU/dVnQxIXre2/U6N2tMMs7dE/7gyUf0wERgNWRsE1QWQhqkC5nVzdPnYvoKg186A6ruYCPhlR8UIrtzS4mUXKaG35obxyE63RqYYtZxvsJBzQg/Fg1x+sv/qv0IIQSaP+uP58fDh1C7qoOqgo1jHs1phRhE4xwEuvG0RY93M8Xshuj+j1SHMD0gvlHIjrdDIg3f4CeWZx9BQijO4ZhVoC2G4YSHK2V2fA8AYlCPkSxXLYn1+OpgNxag39yMR1wv+XcvGknFPQFFHhfck19Oel0oZMCz10cJW9lmZT9kKkBHDX9CGhWbrqCxE6RWhxMZoLrjdQ7wO3RqSJdQY+HhctuLZgMKDUTP1/ZG0DjGOpu4AiwfT6UyXV9HIC63GeCy0iiQa7RO/1Vs+wecncB5jwBq/BTiQf9BRYU+h5eprmvigo3AyWiq1sHwmvcsteCbN9SQJ2DBoRgRkZF6kwdrtXHrC/8NSIJDp79t2zpCs62f2TYmj6qYPQTW3rjneB0="

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker --version
  - docker-compose version
  - echo "Login into Docker Hub"
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - export GIT_SHA=`git rev-parse --short HEAD`
  - echo "Building commit $GIT_SHA"

jobs:
  include:
    - stage: tests
      name: "Unit Tests"
      script:
      - cd ch4
      - docker-compose build db
      - docker-compose build test-postgresql
      - docker-compose run test-postgresql
    - stage: tests
      name: "Static Analysis"
      script:
      - cd ch4
      - docker-compose build static-analysis
      - docker-compose run static-analysis
    - stage: push
      script:
      - cd ch4
      - docker-compose build server
      - docker tag thoughts_server:latest jaimebuelta/thoughts-backend:$GIT_SHA
      - docker push jaimebuelta/thoughts-backend:$GIT_SHA
      - docker tag thoughts_server:latest jaimebuelta/thoughts-backend:$TRAVIS_BRANCH
      deploy:
      - provider: script
        script: docker push jaimebuelta/thoughts-backend:$TRAVIS_BRANCH
        on:
          branch: master        
      - provider: script
        script: docker push jaimebuelta/thoughts-backend:$TRAVIS_TAG
        on:
          tags: True
